---
layout: post
title: "A Dynamic State Pattern"
date: 2006-12-20
tags: ["software development"]
permalink: /2006/12/a-dynamic-state-pattern.html
comments: false
---
{% include JB/setup %}

<div class='post'>
This post is about using the <a href="http://en.wikipedia.org/wiki/GOF" target="_blank">[<span onclick="BLOG_clickHandler(this)" class="blsp-spelling-error" id="SPELLING_ERROR_0">GoF</span>]</a> State Pattern to dynamically build a generic state machine. I assume that people have probably done it before, but I've never seen it documented anywhere, so it seems worth writing a short post about it =)<br /><br />The <a href="http://en.wikipedia.org/wiki/GOF" target="_blank">[<span onclick="BLOG_clickHandler(this)" class="blsp-spelling-error" id="SPELLING_ERROR_1">GoF</span>]</a> State Pattern is a quite well-known design pattern that helps controlling an objects behavior by changing its internal state. Normally you would define a <span style="font-family:courier new;">State</span> interface that defines a couple of state transitions as methods, where each method returns a <span style="font-family:courier new;">State</span> instance that represents the new state after the transition has been performed. Then you would encapsulate the behavior of each state in concrete interchangeable implementations of the <span style="font-family:courier new;">State</span> interface.<br /><br />An often referred to example is a <span onclick="BLOG_clickHandler(this)" class="blsp-spelling-error" id="SPELLING_ERROR_2">TCP</span> connection where methods like <span style="font-family:courier new;">Open()</span>, <span style="font-family:courier new;">Close()</span> and so forth behave differently according to the state of the connection (i.e. the concrete <span style="font-family:courier new;">State </span>implementation that the state machine is currently using). Below is the class diagram of the <span onclick="BLOG_clickHandler(this)" class="blsp-spelling-error" id="SPELLING_ERROR_3">TCP</span> connection example used in the <a href="http://en.wikipedia.org/wiki/Design_Patterns" target="_blank"><span onclick="BLOG_clickHandler(this)" class="blsp-spelling-error" id="SPELLING_ERROR_4">GoF</span> Design Patterns</a> book. As you can see in the class diagram, each state is modeled as a separate class.<br /><br /><a onblur="try {parent.deselectBloggerImageGracefully();} catch(e) {}" href="http://4.bp.blogspot.com/_MoEdKdmWnk0/RYi17zYG6sI/AAAAAAAAAA4/0NodUlkjMXA/s1600-h/tcp-state.gif" target="_blank"><img style="margin: 0px auto 10px; display: block; text-align: center; cursor: pointer;" src="http://4.bp.blogspot.com/_MoEdKdmWnk0/RYi17zYG6sI/AAAAAAAAAA4/0NodUlkjMXA/s400/tcp-state.gif" alt="" id="BLOGGER_PHOTO_ID_5010454624457910978" border="0" /></a><br />There might be cases, however, where you have lots of different states or they might simply not be as clearly defined as in the <span onclick="BLOG_clickHandler(this)" class="blsp-spelling-error" id="SPELLING_ERROR_5">TCP</span> connection case above (hint: that's probably the case if you go<span style="font-style: italic;"> "<span onclick="BLOG_clickHandler(this)" class="blsp-spelling-error" id="SPELLING_ERROR_6">hmm</span>... how the hell should I name state number 421?!?"</span>). Or there might be cases where you just don't know your states at the time your writing your code, because your state machine will be created by some <span onclick="BLOG_clickHandler(this)" class="blsp-spelling-error" id="SPELLING_ERROR_7">runtime</span> input (in that case you probably also don't care about explicit state names).<br /><br />Still, even in these cases just described the idea of the State Pattern can be used. Instead of implementing state behavior in different classes, however, we create instances of a generic <span style="font-family:courier new;">State</span> class and configure each instance's behavior by adding transitions to it that are valid for the particular instance. Transitions are modeled as a generic <span style="font-family:courier new;">Transition</span> class, which is a two-<span onclick="BLOG_clickHandler(this)" class="blsp-spelling-error" id="SPELLING_ERROR_8">tuple</span> consisting of a transition symbol (represented as an <span style="font-family:courier new;">Object</span>) and the new <span style="font-family:courier new;">State</span> instance the transition symbol will lead to. I have illustrated the relationships of the classes below.<br /><br /><a onblur="try {parent.deselectBloggerImageGracefully();} catch(e) {}" href="http://4.bp.blogspot.com/_MoEdKdmWnk0/RYjKjzYG6uI/AAAAAAAAABQ/sJGyybYeLKw/s1600-h/state-generic.png" target="_blank"><img style="margin: 0px auto 10px; display: block; text-align: center; cursor: pointer;" src="http://4.bp.blogspot.com/_MoEdKdmWnk0/RYjKjzYG6uI/AAAAAAAAABQ/sJGyybYeLKw/s400/state-generic.png" alt="" id="BLOGGER_PHOTO_ID_5010477301885233890" border="0" /></a><br /><br />First, a client creates a number of <span style="font-family:courier new;">State</span> instances, probably marking some of them final. Then it creates some <span style="font-family:courier new;">Transition</span> instances and adds them to selected <span style="font-family:courier new;">State</span> instances. Finally, it creates a <span style="font-family:courier new;"><span onclick="BLOG_clickHandler(this)" class="blsp-spelling-error" id="SPELLING_ERROR_9">StateMachine</span></span> by passing it a reference to the initial <span style="font-family:courier new;">State</span>. Subsequently, the <span style="font-family:courier new;"><span onclick="BLOG_clickHandler(this)" class="blsp-spelling-error" id="SPELLING_ERROR_10">StateMachine</span></span> can be used to step through the state space and validate input words. If the <span style="font-family:courier new;"><span onclick="BLOG_clickHandler(this)" class="blsp-spelling-error" id="SPELLING_ERROR_11">StateMachine</span></span>'s <span style="font-family:courier new;">Step()</span> method is called, it internally delegates the call to its current <span style="font-family:courier new;">State</span> instance, which checks if a <span style="font-family:courier new;">Transition</span> with the given transition symbol (i.e. the <span style="font-family:courier new;">Object</span> parameter) has been previously defined. Depending on this the method will return the new <span style="font-family:courier new;">State</span> instance defined by the <span style="font-family:courier new;">Transition</span> or throw an exception. If the method returns successfully, the <span style="font-family:courier new;"><span onclick="BLOG_clickHandler(this)" class="blsp-spelling-error" id="SPELLING_ERROR_12">StateMachine</span></span> updates its current state accordingly and waits for the next transition to be performed.<br /><br />Note that in the above diagram the <span style="font-family:courier new;">State</span> class does not publicly expose <span style="font-family:courier new;"><span onclick="BLOG_clickHandler(this)" class="blsp-spelling-error" id="SPELLING_ERROR_13">canStep</span>()</span> and <span style="font-family:courier new;">step()</span> methods. This is because clients use this class to construct the state space only. For stepping, however, they must use the operations provided in <span style="font-family:courier new;"><span onclick="BLOG_clickHandler(this)" class="blsp-spelling-error" id="SPELLING_ERROR_14">StateMachine</span></span>.<br /><br />Using this pattern, it is very easy to create a fast-stepping state machine implementation. Using, for example, a <span style="font-family:courier new;"><span onclick="BLOG_clickHandler(this)" class="blsp-spelling-error" id="SPELLING_ERROR_15">HashTable</span></span> to look up the <span style="font-family:courier new;">Transition</span>s of a <span style="font-family:courier new;">State</span> given a certain transition symbol, we can easily create a state machine that steps in O(1) time; because all it takes is looking up the <span style="font-family:courier new;">Transition</span> in the <span style="font-family:courier new;"><span onclick="BLOG_clickHandler(this)" class="blsp-spelling-error" id="SPELLING_ERROR_16">HashTable</span></span>.<br /><br />If we want, we can add further optimizations to the state machine. For example upon creating it we probably want to remove potential non-deterministic transitions or get rid of equal states, dead-end states, and so forth. And that's where the fun begins =)<br /><br />Summary: By slightly twisting the original idea of the State Pattern, we can use it to build generic  fast-stepping state machines.
</div>
